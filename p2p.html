<html>
	<head>
		<title> MAKEUP PARTY!!</title>
		
		<style type="text/css">
			body {
				width: 90%;
				margin: 0 auto;}
			#content {overflow: auto;}
			#canvasColumn{
				width: 65%;
				float: left;
				margin: 1%;}
			#feedColumn{
				width: 35%;
				float: right;
				margin: 1%;
			}
			#feedColumn video{
				width:220px; 
				height: 140px;
			}
		</style>

		<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>

		<script type="text/javascript">

		// get user media
		var my_stream = null;

		// webRTC peer and peer id
		var peer = null;
		var peer_id = null;

		// socket server
		var socket = null;

		var init = function(){

			window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

			if(navigator.getUserMedia){
				navigator.getUserMedia({video: true, audio: false}, function(stream){
					my_stream = stream;
					var videoElement = document.getElementById('myVideo');
					videoElement.src = window.URL.createObjectURL(stream) || stream;
					videoElement.play();
				
					//connect to peer server
					peerConnect();

				}, function(err){
					console.log('Failed to get local stream', err);
				});
			}
		};

		// step one : connect to the peerjs server
		var peerConnect = function(){

			// create a new PeerJS object
			peer = new Peer({key: 'bw8m5kivpn5klnmi'});

			// Get an ID from the PeerJS server
			peer.on('open', function(id){
				console.log('My peer ID is: ' + id);
				peer_id = id;

				//connect to socket server (see function below)
				connectSocket();
		});

		// step two : connects to the socket server
		var connectSocket = function(){

			socket = io.connect('/');

			// Connection event
			socket.on('connect', function(){
				console.log("sending out my peer id");
				socket.emit("peer_id", peer_id);
			});

			// Receive other peer ids
			socket.on('peer_id_server', function (data){
				console.log("Got a new peer from server: " + data);

				// call them with our stream
				console.log("Calling peer: " + data);
				var call = peer.call(data, my_stream);

				call.on('stream', function(remoteStream){
					console.log("Got remote stream!");
					var ovideoElement = document.createElement('video');
					ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
					ovideoElement.id = data;
					ovideoElement.play();
					document.getElementById("feedColumn").appendChild(ovideoElement);
				});
			});

			// countDown event from the socket.io server
			socket.on('countdownEvent01', function(count){
				console.log(count);

				// draw the count to the canvas
				var c=document.getElementById("videoCanvas");
				var ctx=c.getContext("2d");

				ctx.clearRect(0, 0, c.width, c.height);
				ctx.font="20px Georgia";
				ctx.fillText(count,10,50);

			});

			//remove video of the user who left
			socket.on('peer_disconnect', function(data){
				console.log("removing video with ID" + data);
				var theVideo =document.getElementById(data);
				theVideo.parentNode.removeChild(theVideo);
			});

		};

			
			// on receiving a call ... 
			peer.on('call', function(incoming_call) {
				console.log("You got a new call");

				// answer the call with an AV stream
				incoming_call.answer(my_stream);

				// when you receive a stream from an incoming call, place it in a video div
				incoming_call.on('stream', function(remoteStream){
					console.log("Incoming stream ...")
					var ovideoElement = document.createElement('video');
					ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
					ovideoElement.play();
					document.getElementById("feedColumn").appendChild(ovideoElement);					
				});
			});
		};

		window.addEventListener('load', init);

		</script>

	</head>
	<body>

		<div id="header">
			<h1> MakeUp Party!!! </h1>
		</div>
		<div id="content">
			<div id="canvasColumn">
			Canvas Column
			<canvas id="videoCanvas" style="z-index:1; position:absolute; left:0px; top0px;" width="400" height="300">Error.</canvas>

			<canvas id="drawCanvas" style="z-index:2; position:absolute; left:0px; top0px;" width="400" height="300">Error.</canvas>
			</div>

			<div id="feedColumn">
			Feed Column
			<br>
			<video id="myVideo"></video>
			</div>
		</div>
	</body>
</html>